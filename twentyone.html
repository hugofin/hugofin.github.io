<!doctype html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<html lang="en-GB">
    <head>
        <title>gambling simulator</title>
        <style>
            :root {
                font-family: system-ui;
            }
            body {
                max-width: 22rem;
                margin: 0rem auto;
                padding: 1rem;
                background-color: #393;
            }

            .hand {
                display: flex;
                flex-direction: row;
            }

            .row {
                display: flex;
            }

            .dealt {
                display: flex;
                flex-direction: column;
                left: 10rem;
            }

            .footer {
                display: flex;
                flex-direction: row;
                column-gap: 4rem;
                position: fixed;
                bottom: 3rem;
            }

            .options {
                display: flex;
                flex-direction: column;
                row-gap: 1rem;
                width: 7rem;
            }

            card {
                width: 3.8rem;
                height: 5.8rem;
                border: 0.2rem #e0dba8 solid;
                border-radius: 0.5rem;
                padding: 1rem;
                background-color: #fffded;
            }

            button {
                height: 4rem;
                width: 100%;
                padding: 0.1rem;
                background: none;
                font-style: oblique;
                font-weight: bold;
                border: 2px #fafafa dashed;
                color: #fafafa;
            }

            button:active {
                background-color: #6c6;
            }

            button:disabled {
                background-color: #282;
                color: #c7c7c7;
                border-color: #c7c7c7;
            }

            .♥ {
                color: #d00;
            }

            .♠ {
                color: #000;
            }

            .♦ {
                color: #f61;
            }

            .♣ {
                color: #30c;
            }

            .down {
                background-color: #f23036;
                color: rgba(0, 0, 0, 0);
                border: 2px #ad2227 solid;
            }
        </style>
    </head>
    <body>
        <div class="row">
            <div class="hand">
                <card id="d0"></card>
                <card
                    id="d1"
                    style="position: relative; top: 2.5rem; left: -4.5rem"
                ></card>
            </div>

            <div class="dealt">
                <card id="d2" style="display: none"></card>
                <card
                    id="d3"
                    style="
                        position: relative;
                        top: -7rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="d4"
                    style="position: relative; top: -13rem; display: none"
                ></card>
                <card
                    id="d5"
                    style="
                        position: relative;
                        top: -19.5rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="d6"
                    style="position: relative; top: -25.5rem; display: none"
                ></card>
                <card
                    id="d7"
                    style="
                        position: relative;
                        top: -32rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="d8"
                    style="position: relative; top: -38rem; display: none"
                ></card>
            </div>
        </div>

        <div class="row" style="position: fixed; top: 15rem">
            <div class="hand">
                <card id="p0"></card>
                <card
                    id="p1"
                    style="position: relative; top: 2.5rem; left: -4.5rem"
                ></card>
            </div>

            <div class="dealt">
                <card id="p2" style="display: none"></card>
                <card
                    id="p3"
                    style="
                        position: relative;
                        top: -7rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="p4"
                    style="position: relative; top: -13rem; display: none"
                ></card>
                <card
                    id="p5"
                    style="
                        position: relative;
                        top: -19.5rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="p6"
                    style="position: relative; top: -25.5rem; display: none"
                ></card>
                <card
                    id="p7"
                    style="
                        position: relative;
                        top: -32rem;
                        left: 3rem;
                        display: none;
                    "
                ></card>
                <card
                    id="p8"
                    style="position: relative; top: -38rem; display: none"
                ></card>
            </div>
        </div>

        <div style="position: fixed; bottom: 15rem; color: #fafafa">
            <div id="result" onclick="advance()"></div>
            <div id="score"></div>
            <div style="display: flex; flex-direction: row; column-gap: 3rem">
                <div id="wallet"></div>
                <div id="round"></div>
            </div>
        </div>

        <div class="footer">
            <div class="options">
                <button id="hit" onclick="hit(playerHand)">carte!</button>

                <button id="stand" onclick="stand()">je m'y tiens...</button>
            </div>

            <card class="down"></card>
        </div>

        <script>
            var deck = [];

            var playerHand = [];
            var wallet = 10;
            var dealerHand = [];

            var turn = "p";
            var round = 1;

            var highScore = localStorage.getItem("highScore");
            function draw(deck) {
                var i = Math.floor(Math.random() * deck.length);
                var c = deck[i];
                deck.splice(i, 1);
                return c;
            }

            function hit(hand) {
                var card = draw(deck);

                hand.push(card);
                i = hand.length;

                document
                    .getElementById(`${turn}${i - 1}`)
                    .classList.add(hand[i - 1][0]);
                document.getElementById(`${turn}${i - 1}`).innerText =
                    `${hand[i - 1][0]}${hand[i - 1][1]}`;
                document.getElementById(`${turn}${i - 1}`).style.display =
                    "block";

                if (turn == "p" && Math.min(...sumHand(hand)) > 21) {
                    stand();
                }
            }

            function stand() {
                turn = "d";

                document.getElementById("hit").disabled = "disabled";
                document.getElementById("stand").disabled = "disabled";
                document.getElementById("d1").classList.remove("down");

                while (!(Math.max(...sumHand(dealerHand)) > 16)) {
                    hit(dealerHand);
                }

                var playerHighscore = Math.max(
                    ...sumHand(playerHand).filter(filterBusts),
                );
                var dealerHighscore = Math.max(
                    ...sumHand(dealerHand).filter(filterBusts),
                );

                var winner = "the house wins";

                if (playerHighscore < 22) {
                    if (
                        dealerHighscore > 21 ||
                        playerHighscore > dealerHighscore
                    ) {
                        winner = "you win!!";
                        wallet += 2 * round;
                    }
                    if (playerHighscore == dealerHighscore) {
                        winner = "it's a draw";
                        wallet += round;
                    }
                } else if (dealerHighscore > 21) {
                    winner = "both loose";
                }
                round += 1;
                document.getElementById("wallet").innerText = `£${wallet}`;

                if (wallet >= round) {
                    document.getElementById("result").innerText =
                        `${winner} , go to next round →`;
                } else {
                    document.getElementById("result").innerText =
                        `${winner} , c'est fini :(  try again ↻`;
                    document.getElementById("result").onclick = function () {
                        beginAgain();
                    };
                    if (round > highScore) {
                        document.getElementById("score").innerText =
                            `Well done! ${round} is a new high score`;
                        localStorage.setItem("highScore", round);
                    } else {
                        document.getElementById("score").innerText =
                            `your high score is ${highScore}`;
                    }
                }
            }

            function filterBusts(value) {
                return value <= 21;
            }

            function advance() {
                wallet -= round;
                reset();
            }

            function beginAgain() {
                round = 1;
                wallet = 10;
                document.getElementById("score").innerText = " ";
                highScore = localStorage.getItem("highScore");
                reset();
            }

            function reset() {
                deck = [];
                dealerHand = [];
                playerHand = [];
                turn = "p";

                // ⚘ ⚫︎ ⚔ bell cup leaf
                for (suit of ["♥", "♠", "♦", "♣"]) {
                    for (rank of [
                        "2",
                        "3",
                        "4",
                        "5",
                        "6",
                        "7",
                        "8",
                        "9",
                        "10",
                        "J",
                        "Q",
                        "K",
                        "A",
                    ]) {
                        deck.push([suit, rank]);
                    }
                }

                for (pos of [0, 1]) {
                    playerHand.push(draw(deck));

                    document
                        .getElementById(`p${pos}`)
                        .classList.remove("♥", "♠", "♦", "♣");
                    document
                        .getElementById(`p${pos}`)
                        .classList.add(playerHand[pos][0]);
                    document.getElementById(`p${pos}`).innerText =
                        `${playerHand[pos][0]}${playerHand[pos][1]}`;

                    dealerHand.push(draw(deck));

                    document
                        .getElementById(`d${pos}`)
                        .classList.remove("♥", "♠", "♦", "♣");
                    document
                        .getElementById(`d${pos}`)
                        .classList.add(dealerHand[pos][0]);
                    document.getElementById(`d${pos}`).innerText =
                        `${dealerHand[pos][0]}${dealerHand[pos][1]}`;
                }

                for (var i = 2; i < 8; i++) {
                    document.getElementById(`p${i}`).style.display = "none";
                    document
                        .getElementById(`p${i}`)
                        .classList.remove("♥", "♠", "♦", "♣");

                    document.getElementById(`d${i}`).style.display = "none";
                    document
                        .getElementById(`d${i}`)
                        .classList.remove("♥", "♠", "♦", "♣");
                }

                document.getElementById("d1").classList.add("down");

                document.getElementById("hit").removeAttribute("disabled");
                document.getElementById("stand").removeAttribute("disabled");

                document.getElementById("result").innerText = " ";
                document.getElementById("wallet").innerText = `£${wallet}`;
                document.getElementById("round").innerText =
                    `it's round ${round}`;

                document.getElementById("result").onclick = function () {
                    advance();
                };
            }

            function sumHand(hand) {
                var sums = [];
                var h2e = [];

                for (var i = 0; i < hand.length; i++) {
                    if (hand[i][1] == "A") {
                        copy1 = structuredClone(hand);
                        copy1[i][1] = "1";
                        h2e.push(copy1);
                        copy2 = structuredClone(hand);
                        copy2[i][1] = "11";
                        h2e.push(copy2);
                    }
                }

                if (h2e.length == 0) h2e.push(hand);

                for (hand of h2e) {
                    var sum = 0;

                    for (card of hand) {
                        switch (card[1]) {
                            case "K":
                            case "Q":
                            case "J":
                                sum += 10;
                                break;
                            case "A":
                                sum += 1;
                                break;
                            default:
                                sum += parseInt(card[1]);
                        }
                    }
                    sums.push(sum);
                }
                return sums;
            }
            reset();
        </script>
    </body>
</html>
