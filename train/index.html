<!doctype html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<html lang="en-GB">
    <head>
        <title>trainstationcoldle</title>
        <link
            href="https://fonts.cdnfonts.com/css/dot-matrix"
            rel="stylesheet"
        />
        <style>
            :root {
                font-family: monospace;
            }

            body {
                margin: 0rem auto;
            }

            marquee {
                font-family: "Dot Matrix";
                font-weight: normal;
                font-size: 25px;
                transform: skewX(-5deg);
                margin: 0px;
            }

            .top {
                background-color: #223;
                position: fixed;
                top: 0px;
                width: 100%;
                height: 4rem;
                color: #9d9;
                padding: 0.8rem;
                align-content: center;
                border-bottom: 1rem solid #ccc;
                margin-bottom: 1rem;
                z-index: 1;
            }

            .midriff {
                overflow: auto;
            }

            .footer {
                background-color: #ef3c24;
                height: 9rem;
                color: #fff;
                display: flex;
                flex-direction: column;
                row-gap: 0.2rem;
                padding: 0.8rem;
                position: fixed;
                width: 100%;
                bottom: 0px;
                align-items: center;
            }

            .attempts {
                display: flex;
                flex-direction: column;
                row-gap: 1rem;
                align-items: center;
                padding-bottom: 12rem;
                padding-top: 8rem;
            }

            .ticket {
                width: 18rem;
                height: 10rem;
                background-color: #ff6816;
                display: flex;
                flex-direction: column;
                padding-top: 2rem;
                border-radius: 10px;
            }

            .middle {
                height: 8rem;
                background-color: #fff8af;
                display: flex;
                flex-direction: row;
                column-gap: 1rem;
                align-items: center;
                justify-content: center;
            }

            .letter {
                font-size: 20px;
                width: 2.5rem;
                height: 2.5rem;
                color: #fff;
                text-align: center;
                align-content: center;
            }

            .far {
                background-color: #aaa;
            }

            .close {
                background-color: #faa;
            }

            .exact {
                background-color: #ada;
            }

            .loc {
                position: relative;
                bottom: 1px;
                left: 3px;
                color: #fff;
                text-wrap: nowrap;
                max-height: 1rem;
                padding-bottom: 1rem;
                font-size: 15px;
            }

            .row {
                display: flex;
                flex-direction: row;
                align-content: baseline;
            }

            input {
                width: 9em;
                text-align: center;
                max-height: 3em;
                font-size: 25px;
                font-family: monospace;
            }

            .subButton {
                width: 3em;
                text-align: center;
                max-height: 3em;
                font-size: 25px;
                font-family: monospace;
                border: none;
                background-color: rgba(0, 0, 0, 0);
                color: #fff;
            }

            .subButton:active {
                background-color: rgba(255, 255, 255, 0.4);
            }

            .endButton {
                width: 100%;
                text-align: center;
                font-family: monospace;
                border: none;
                background-color: #ff6816;
                color: #fff;
            }

            .endButton:active {
                background-color: #ff9846;
            }

            .grey {
                position: fixed;
                top: 0px;
                height: 100vh;
                width: 100vw;
                background-color: rgba(0, 0, 0, 0.4);
                z-index: 2;
                display: none;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }

            .fin {
                height: 10rem;
                width: 10rem;
                text-align: center;
                position: fixed;
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <div class="top">
            <marquee id="today"></marquee>
        </div>

        <div class="midriff">
            <div class="attempts" id="attempts"></div>
        </div>

        <div class="footer">
            <div>
                <form class="row">
                    <input
                        id="input"
                        type="text"
                        name="query"
                        autocomplete="off"
                        maxlength="3"
                        autocapitalize="characters"
                    />
                    <input
                        type="submit"
                        id="guess"
                        value="â†’"
                        class="subButton"
                    />
                </form>
            </div>

            <span id="res" style="font-size: 18px" onclick="reset()"></span>
        </div>

        <div class="grey" id="grey">
            <div
                style="
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                "
                class="fin"
            >
                <div id="fin"></div>
                <div style="display: flex; flex-direction: column">
                    <button class="endButton" onclick="result()">
                        copy results
                    </button>
                    <button class="endButton" onclick="reset()">
                        play again?
                    </button>
                </div>
            </div>
        </div>

        <script src="./stations.js"></script>
        <script>
            var guesses = [];
            var correct = ["?", "?", "?"];
            var daily = true;

            const stationsDict = {};
            stations.map(
                (s) =>
                    (stationsDict[s.crsCode] = {
                        stationName: s.stationName,
                        lat: s.lat,
                        long: s.long,
                        crsCode: s.crsCode,
                        constituentCountry: s.constituentCountry,
                    }),
            );

            const d = new Date();
            const seed = parseInt(
                `${d.getUTCDate()}${d.getUTCFullYear()}${d.getUTCMonth()}`,
            );
            function random(seed) {
                let x = Math.sin(seed + 1) * 10000;
                return x - Math.floor(x);
            }
            var today = stations[Math.floor(random(seed) * stations.length)];
            console.log(today);

            const setHead = () => {
                document.getElementById("today").innerText =
                    `Calling at: ${today.stationName} (${correct[0]}${correct[1]}${correct[2]})`;
            };
            setHead();

            const form = document.forms[0];
            form.onsubmit = (e) => {
                e.preventDefault();
                const g = form.query.value.toUpperCase();
                form.query.value = "";
                tryGuess(g);
            };

            function reset() {
                today = stations[Math.floor(Math.random() * stations.length)];
                guesses = [];
                correct = ["?", "?", "?"];
                setHead();

                const at = document.getElementById("attempts");
                while (at.firstChild) {
                    at.removeChild(at.lastChild);
                }

                document.getElementById("res").innerText = "";
                input.disabled = "";
                document.getElementById("grey").style.display = "none";
            }

            function tryGuess(g) {
                if (g.length == 3 && !guesses.includes(g)) {
                    addGuess(g);
                }
                if (g == today.crsCode) {
                    input.disabled = "disabled";
                    if (daily) {
                        daily = false;
                        document.getElementById("grey").style.display = "flex";
                        document.getElementById("fin").innerText =
                            `well done! you got today's station in ${guesses.length} guesses!`;
                    } else {
                        document.getElementById("res").innerText =
                            "well done! go again â†»";
                    }
                }
            }

            function addGuess(g) {
                guesses.push(g);

                var attempt = document.createElement("div");
                attempt.classList.add("ticket");
                var mid = document.createElement("div");
                mid.classList.add("middle");
                attempt.appendChild(mid);

                for (var l in g) {
                    var newCel = document.createElement("div");
                    newCel.innerText = g[l];
                    switch (true) {
                        case g[l] == today.crsCode[l]:
                            newCel.classList.add("letter", "exact");
                            correct[l] = g[l];
                            setHead();
                            break;
                        case today.crsCode.includes(g[l]) &&
                            !correct.includes(g[l]):
                            newCel.classList.add("letter", "close");
                            break;
                        default:
                            newCel.classList.add("letter", "far");
                            break;
                    }
                    mid.appendChild(newCel);
                }

                var loc = document.createElement("span");
                loc.classList.add("loc");
                loc.innerText =
                    g in stationsDict ? stationsDict[g].stationName : "???";
                attempt.appendChild(loc);
                document.getElementById("attempts").appendChild(attempt);
                attempt.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                });
            }

            function result() {
                const carriage = "ðŸšƒ";
                const share = `ðŸš‚${carriage.repeat(guesses.length)}\n${d.toLocaleDateString("en-GB")} - ${today.stationName} \nhugofin.github.io/train`;
                navigator.clipboard.writeText(share);
            }
        </script>
    </body>
</html>
