<!doctype html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<html lang="en-GB">
    <head>
        <title>can you guess what tree this is?</title>
        <style>
            :root {
                font-family: system-ui;
            }
            body {
                max-width: 20rem;
                margin: 2rem auto;
            }
            .life {
                font-family: system-ui;
                font-size: 20px;
                color: #ff4444;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <h1>dayleaf</h1>
        <img src="" id="image" height="300" />
        <div>
            <span id="h1" class="life">♥</span>
            <span id="h2" class="life">♥</span>
            <span id="h3" class="life">♥</span>
            <span id="h4" class="life">♥</span>
            <span id="h5" class="life">♥</span>
        </div>
        <div id="answer"></div>
        <form onsubmit="return false">
            <label>
                <input id="query" autocomplete="off" />
                <input
                    id="submit"
                    type="submit"
                    value="guess..."
                    onclick="realTimeGuess()"
                />
            </label>
        </form>
        <div id="result"></div>
        <ul id="guesses">
            <li id="g5" style="display: none"></li>
            <li id="g4" style="display: none"></li>
            <li id="g3" style="display: none"></li>
            <li id="g2" style="display: none"></li>
            <li id="g1" style="display: none"></li>
        </ul>

        <div id="score"></div>

        <script>
            const trees = [
                [
                    "oak",
                    "https://upload.wikimedia.org/wikipedia/commons/a/af/Quercus_robur.jpg",
                ],
                [
                    "silver birch",
                    "https://upload.wikimedia.org/wikipedia/commons/8/8a/Betula_pendula_Finland.jpg",
                ],
            ];

            const d = new Date();
            const seed = `${d.getUTCDate()}${d.getUTCFullYear()}${d.getUTCMonth()}`;
            let previousGuesses = [];
            let finishedToday = "no";

            function random() {
                let x = Math.sin(seed) * 10000;
                return x - Math.floor(x);
            }

            const todays = trees[Math.floor(random() * trees.length)];
            document.getElementById("image").src = todays[1];

            let wr = 0;
            let wins = localStorage.getItem("wins");
            let games = localStorage.getItem("games");
            const lastSeed = localStorage.getItem("lastSeed");
            if (lastSeed != seed) {
                localStorage.setItem("finishedToday", finishedToday);
                localStorage.setItem("lastSeed", seed);
                localStorage.setItem(
                    "previousGuesses",
                    JSON.stringify(previousGuesses),
                );
            } else {
                finishedToday = localStorage.getItem("finishedToday");
                let x = JSON.parse(localStorage.getItem("previousGuesses"));
                for (var g of x) {
                    guess(g.replace("✕", "").replace("✓", ""));
                }
            }

            function realTimeGuess() {
                let x = document.getElementById("query").value;
                guess(x);
                localStorage.setItem(
                    "previousGuesses",
                    JSON.stringify(previousGuesses),
                );
            }

            function guess(g) {
                let res = "";

                if (g) {
                    if (
                        g.toLowerCase().replace(" ", "") ==
                        todays[0].replaceAll(" ", "")
                    ) {
                        res = `✓ ${g}`;
                        document.getElementById("query").disabled = "disabled";
                        document.getElementById("submit").disabled = "disabled";

                        if (finishedToday != "yes") {
                            wins++;
                            games++;
                            localStorage.setItem("finishedToday", "yes");
                        }

                        localStorage.setItem("wins", wins);
                        localStorage.setItem("games", games);

                        document.getElementById("score").innerText =
                            `Well done! your win rate is ${Math.floor((wins / games) * 100)}%`;
                    } else {
                        res = `✕ ${g}`;
                        document.getElementById(
                            `h${5 - previousGuesses.length}`,
                        ).innerText = "♡";
                        document.getElementById("query").value = "";
                    }

                    previousGuesses.push(res);
                    document.getElementById(
                        `g${previousGuesses.length}`,
                    ).innerText = res;
                    document.getElementById(
                        `g${previousGuesses.length}`,
                    ).style.display = "block";

                    if (previousGuesses.length == 5) {
                        document.getElementById("query").disabled = "disabled";
                        document.getElementById("submit").disabled = "disabled";
                        document.getElementById("answer").innerText = todays[0];

                        if (finishedToday != "yes") {
                            games++;
                            localStorage.setItem("finishedToday", "yes");
                        }

                        if (wins != 0) {
                            wr = (wins / games) * 100;
                        }

                        localStorage.setItem("games", games);

                        document.getElementById("score").innerText =
                            `Better luck next time, your win rate is ${Math.floor(wr)}%`;
                    }
                }
            }
        </script>
    </body>
</html>
